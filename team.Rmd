---
title: "team"
author: "Jacob Shoemaker; jshoemaker2249, Qinwen Yang; AngelQinwen"
date: "4/17/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(tidyverse) 
library(lubridate)
library(maps)

acc <- read.csv("https://raw.githubusercontent.com/xdaiISU/ds202materials/master/hwlabs/fars2017/accident.csv", stringsAsFactors = FALSE)
per <- read.csv("https://raw.githubusercontent.com/xdaiISU/ds202materials/master/hwlabs/fars2017/person.csv", stringsAsFactors = FALSE)
```

are there some days of the week where more accidents happen than on others (use variable DAY_WEEK)?
what time of the day do accidents happen (use variable HOUR)?
what is the number of accidents with at least one drunk driver (use variable DRUNK_DR)?

```{r}

Dayweek <- acc %>% group_by(DAY_WEEK) %>% summarise(n=n())
Dayweek$DAY_WEEK = as.factor(c("Sunday","Monday","Tuesday", "Wednesday", "Thursday", "Friday","Saturday"))
ggplot(Dayweek, aes(x=DAY_WEEK, y=n, fill=DAY_WEEK))+geom_bar(stat="identity", width = 0.5)+xlab('Day of Week')+ylab('Number of Accident')+ggtitle('Relationship between Day of Week and Number of Accident ')+ scale_fill_manual(values = c("red","grey","red","red","grey","grey","grey"))+theme(axis.text.x = element_text(angle=90, hjust=1))
```


From the barplot, we can conclude that Friday, Saturday and Sunday of a week have more accidents happen than others.

```{r}

dat <- filter(acc, acc$HOUR <= 24)
ggplot(dat, aes(x=HOUR)) + geom_histogram() + scale_x_continuous(breaks = seq(0,24,1)) + xlab("Hour of Day") + ylab("Number of Accidents")
```


The most accidents happen in the evening, between 6pm and 9pm.

```{r}
drunk <- filter(acc, acc$DRUNK_DR >= 1)
drunk %>% summarise(numAcc = n())
```

There have been 8,769 accidents with at least one drunk driver.


Load the person table. Identify drivers (PER_TYP == 1, see fars manual) and subset on them.
Join accident and driver table (work out which variable(s) to use)

```{r}
drivers <- subset(per, PER_TYP ==1)
dat <- join(drivers, acc, type= "inner")
```


Tally the number of accidents by day of the week (DAY_WEEK), hour of the day (HOUR) and gender (SEX). Visualize the results!
```{r}
dat %>% group_by(DAY_WEEK) %>% summarize(count = n())
ggplot(dat, aes(x=DAY_WEEK))+ geom_histogram() + scale_x_continuous(breaks = seq(1,7,1), labels = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")) + xlab("Day of the Week") + ylab("Number of Accidents")
```


```{r}
filter(dat, dat$HOUR <= 24) %>% group_by(HOUR) %>% summarise(count = n()) 
dat1 <- filter(dat, dat$HOUR <= 24)
ggplot(dat1, aes(x = HOUR)) + geom_histogram() + scale_x_continuous(breaks = seq(0,24,1)) + xlab("Hour of Day") + ylab("Number of Accidents")
```


```{r}
dat %>% group_by(SEX) %>% summarise(count = n())
dat$SEX <- ifelse(dat$SEX == 8, 3, dat$SEX)
dat$SEX <- ifelse(dat$SEX == 9, 4, dat$SEX)
ggplot(dat, aes(x=SEX)) + geom_histogram() + scale_x_continuous(breaks = seq(1,4,1), labels = c("Male", "Female","Not Reported", "Unknown")) + ylab("Number of Accidents")
```

```{r}
JoinTab <- dat %>% filter(HOUR <= 24)
JoinTab$SEX<-factor(JoinTab$SEX)
levels(JoinTab$SEX) <- c("Male", "Female", "Not Reported","Unknown")
JoinTab$DAY_WEEK <- factor(JoinTab$DAY_WEEK)
levels(JoinTab$DAY_WEEK) <- c("Sunday","Monday","Tuesday","Wednesday", "Thursday","Friday","Saturday")
GroupJoinTab <- JoinTab %>% group_by(SEX, DAY_WEEK, HOUR) %>% summarise(n=n())
ggplot(GroupJoinTab, aes(x=SEX,y=n, fill=DAY_WEEK))+geom_bar(stat = "identity")+facet_wrap(~HOUR)+theme(axis.text.x = element_text(angle=90, hjust=1, size=10))+theme(axis.text=element_text(size=6))+ylim(c(0,400))+ylab('Number of Accidents')
  
```


Now plot a choropleth map of accidents on a county level
Read the description for the STATE and COUNTY columns in the FARS manual.
The state & county codes are Geographic Locator Codes (GLCs) from the General Services Administrationâ€™s (GSA) publication
Use readxl::read_xlsx to read in the GLCs
Visualize the number of accidents in each county using a choropleth map. To do this, you need to join the accident data, GLCs, and appropriate map data.
Can you find seasonal trends in accident occurrences in different states? Is summer or winter more dangerous? Why?


Use readxl::read_xlsx to read in the GLCs
```{r}
#help(read_xlsx)
#str(GLCs)
GLCs <-  readxl::read_xlsx("FRPP GLC United States.xlsx", skip = 1)

```


Connecting Data and Make Maps:
Now plot a choropleth map of accidents on a county level
```{r}
#Draft:ggplot(data=counties, aes(x=LONGITUD,y=LATITUDE ))+geom_polygon(aes(group=group,color=LATITUDE))+geom_point(data=accident, aes(x=LONGITUD, y=LATITUDE))+xlim(c(-171, 250))

#Create a counties variable for map data named county data frame
counties <- map_data('county')
#Rename counties long and lat to LONGITUD, LATITUDE
counties <- counties %>% rename(LONGITUD =long)
counties <- counties %>% rename(LATITUDE = lat)
accident <- acc
#Create var accident1 to summarize number of accidents by each COUNTY
(accident1 <- accident %>% group_by(COUNTY) %>% summarise(`Number Of Accident`=n()))
#Rename GLCs `County Code` to COUNTY
GLCs <- GLCs %>% rename(COUNTY = `County Code`)
#Change GLCs COUNTY type to numeric
GLCs$COUNTY <- as.numeric(GLCs$COUNTY)
#Create JoinTwo var to inner join two data frames GLCs and accident1 by COUNTY
JoinTwo <- inner_join(GLCs, accident1, by="COUNTY")
#Rename...
JoinTwo <- JoinTwo %>% rename(region = `State Name`)
#change JoinTwo region column to lower case
JoinTwo$region <- tolower(JoinTwo$region)
#Rename...
JoinTwo <- JoinTwo %>% rename(subregion = `County Name`)
#lower case
JoinTwo$subregion <- tolower(JoinTwo$subregion)
#Create car FinalJoin to inner join counties and JoinTwo by region and subregion
FinalJoin <- inner_join(counties, JoinTwo, by=c("region","subregion"))
#plot 
ggplot(data = FinalJoin, aes(x=LONGITUD,y=LATITUDE))+geom_polygon(aes(group=group, fill=`Number Of Accident`))+ggtitle('choropleth map of accidents')

```

Can you find seasonal trends in accident occurrences in different states? Is summer or winter more dangerous? Why?
```{r}
acc <- acc %>% filter(WEATHER < 98)

Weather <- acc %>% group_by(STATE, WEATHER) %>% summarise(n=n())

ggplot(Weather, aes(x=STATE, y=n, fill=WEATHER))+geom_bar(stat = "identity")+xlim(c(0,60))+
  ylim(c(0, 3500))+ylab('Number of Accidents')

```





